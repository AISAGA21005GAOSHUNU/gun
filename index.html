<!doctype html>
<html lang="zh-Hans">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>å›¾ç‰‡è¯†å­—ï¼šæªçš„ä¸­æ–‡ï¼ˆä¸¤äººå¯¹æˆ˜ï½œæ— æç¤ºï½œæ‰‹åŠ¨å›åˆï¼‰</title>

<style>
  :root{
    --card: rgba(255,255,255,.86);
    --shadow: 0 18px 50px rgba(0,0,0,.28);
    --radius: 22px;

    --p1:#2563eb;
    --p2:#ef4444;
    --good: rgba(34,197,94,.18);
    --bad: rgba(239,68,68,.16);
  }

  body{
    margin:0;
    font-family: system-ui, -apple-system, "Noto Sans SC","PingFang SC", Arial, sans-serif;
    color: #0b1220;
    background:
      radial-gradient(1200px 600px at 15% 20%, rgba(34,197,94,.25), transparent 60%),
      radial-gradient(900px 500px at 90% 15%, rgba(250,204,21,.22), transparent 58%),
      radial-gradient(1000px 600px at 70% 85%, rgba(14,165,233,.18), transparent 60%),
      radial-gradient(140px 110px at 12% 36%, rgba(20,83,45,.55), transparent 70%),
      radial-gradient(190px 140px at 23% 66%, rgba(30,64,175,.18), transparent 70%),
      radial-gradient(210px 160px at 38% 45%, rgba(124,45,18,.24), transparent 70%),
      radial-gradient(160px 120px at 58% 28%, rgba(20,83,45,.45), transparent 70%),
      radial-gradient(220px 170px at 72% 56%, rgba(63,98,18,.40), transparent 70%),
      radial-gradient(200px 150px at 88% 44%, rgba(120,53,15,.28), transparent 70%),
      linear-gradient(135deg, #0b1a12, #0b1220);
    min-height:100vh;
  }

  header{
    position:sticky; top:0; z-index:30;
    backdrop-filter: blur(10px);
    background: linear-gradient(180deg, rgba(0,0,0,.58), rgba(0,0,0,.25));
    border-bottom: 1px solid rgba(255,255,255,.10);
  }

  .wrap{max-width:1220px; margin:0 auto; padding:14px 18px;}
  .top{display:flex; align-items:center; justify-content:space-between; gap:12px; flex-wrap:wrap;}

  .title{display:flex; align-items:baseline; gap:10px; flex-wrap:wrap; color:#e5e7eb;}
  h1{margin:0; font-size:22px; letter-spacing:.3px;}
  .sub{font-size:14px; color: rgba(226,232,240,.86)}

  .controls{display:flex; align-items:center; gap:10px; flex-wrap:wrap;}
  .chip{
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 12px; border-radius:999px;
    background: rgba(255,255,255,.10);
    border: 1px solid rgba(255,255,255,.16);
    color:#e5e7eb; font-size:14px;
  }

  select{
    font-size:14px;
    padding:9px 10px;
    border-radius:12px;
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.25);
    color:#f8fafc;
    outline:none;
  }

  .btn{
    font-size:16px;
    padding:10px 14px;
    border-radius:14px;
    border: 1px solid rgba(255,255,255,.16);
    background: rgba(255,255,255,.12);
    color:#f8fafc;
    cursor:pointer;
    transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    user-select:none;
  }
  .btn:hover{ transform: translateY(-1px); box-shadow: 0 12px 26px rgba(0,0,0,.25); background: rgba(255,255,255,.18);}
  .btn:active{ transform: translateY(0px) scale(.99); }

  main .grid{
    max-width:1220px;
    margin:16px auto 26px;
    padding:0 18px;
    display:grid;
    grid-template-columns: 1.2fr .8fr;
    gap:18px;
  }
  @media (max-width:980px){ main .grid{ grid-template-columns: 1fr; } }

  .card{
    border-radius: var(--radius);
    background: var(--card);
    border: 1px solid rgba(255,255,255,.22);
    box-shadow: var(--shadow);
    padding:18px;
  }

  .media{
    height:460px;
    border-radius:18px;
    border: 1px dashed rgba(0,0,0,.18);
    background: rgba(255,255,255,.55);
    display:flex; align-items:center; justify-content:center;
    overflow:hidden;
  }
  .media img{
    width:100%; height:100%;
    object-fit:contain;
    padding:14px;
  }

  .turn{
    display:flex; align-items:center; gap:10px; flex-wrap:wrap;
    margin-bottom:10px;
  }
  .tag{
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 12px; border-radius:999px;
    border: 1px solid rgba(2,6,23,.10);
    background: rgba(255,255,255,.88);
    font-size:14px;
    user-select:none;
  }
  .tag .dot{ width:10px; height:10px; border-radius:999px; background:#94a3b8; }
  .tag.p1 .dot{ background: var(--p1); }
  .tag.p2 .dot{ background: var(--p2); }
  .tag.active{
    outline: 3px solid rgba(250,204,21,.35);
    box-shadow: 0 10px 22px rgba(0,0,0,.12);
    transform: translateY(-1px);
  }

  .pill{
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 12px; border-radius:999px;
    background: rgba(15,23,42,.06);
    border: 1px solid rgba(15,23,42,.10);
    font-size:14px;
  }
  .pill strong{font-size:16px;}

  .barWrap{
    width:100%; height:12px;
    border-radius:999px;
    background: rgba(2,6,23,.08);
    border: 1px solid rgba(2,6,23,.08);
    overflow:hidden;
    margin:10px 0 14px;
  }
  .bar{
    height:100%;
    width:0%;
    border-radius:999px;
    background: linear-gradient(90deg, rgba(34,197,94,.95), rgba(250,204,21,.95));
    transition: width .25s ease;
  }

  .promptRow{
    display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap;
  }
  .neutral{
    font-size:14px;
    color: rgba(15,23,42,.75);
    padding:10px 12px;
    border-radius:14px;
    background: rgba(2,6,23,.04);
    border: 1px solid rgba(2,6,23,.08);
  }
  .iconBtn{
    font-size:16px;
    padding:10px 12px;
    border-radius:14px;
    border: 1px solid rgba(2,6,23,.12);
    background: rgba(255,255,255,.92);
    cursor:pointer;
  }

  .choices{
    display:grid;
    grid-template-columns:1fr;
    gap:12px;
    margin-top:12px;
  }
  .choice{
    width:100%;
    font-size:22px;
    font-weight:900;
    padding:16px 16px;
    border-radius:18px;
    border: 1px solid rgba(2,6,23,.14);
    background: rgba(255,255,255,.92);
    cursor:pointer;
    transition: transform .12s ease, box-shadow .12s ease, background .12s ease;
    text-align:left;
    display:flex;
    align-items:center;
    justify-content:flex-start;
    gap:14px;
  }
  .choice:hover{ transform: translateY(-1px); box-shadow: 0 12px 22px rgba(0,0,0,.14); background:#fff; }
  .choice:active{ transform: translateY(0px) scale(.99); }

  .num{
    min-width:44px;
    height:36px;
    display:inline-flex;
    align-items:center;
    justify-content:center;
    border-radius:12px;
    border: 1px solid rgba(2,6,23,.12);
    background: rgba(2,6,23,.04);
    font-size:18px;
    font-weight:900;
  }
  .txt{ font-size:22px; font-weight:900; }

  .choice.wrong{
    border-color: rgba(239,68,68,.35);
    background: rgba(239,68,68,.08);
    animation: shake .22s ease-in-out 0s 2;
  }
  @keyframes shake{
    0%{ transform: translateX(0); }
    25%{ transform: translateX(-6px); }
    50%{ transform: translateX(6px); }
    75%{ transform: translateX(-4px); }
    100%{ transform: translateX(0); }
  }

  .msg{
    margin-top:14px;
    padding:14px 14px;
    border-radius:16px;
    border: 1px solid rgba(2,6,23,.10);
    background: rgba(255,255,255,.85);
    min-height:64px;
    font-size:16px;
    line-height:1.5;
  }
  .msg.ok{ background: var(--good); border-color: rgba(34,197,94,.26); }
  .msg.bad{ background: var(--bad); border-color: rgba(239,68,68,.20); }

  .scoreBoard{
    display:grid;
    grid-template-columns:1fr 1fr;
    gap:10px;
    margin-top:10px;
  }
  .sb{
    border-radius:18px;
    padding:12px 12px;
    border: 1px solid rgba(2,6,23,.10);
    background: rgba(255,255,255,.88);
  }
  .sb .name{
    display:flex; align-items:center; justify-content:space-between; gap:10px;
    font-weight:900; font-size:16px;
  }
  .sb .meta{
    margin-top:8px;
    display:flex; gap:10px; flex-wrap:wrap;
    font-size:13px;
    color: rgba(15,23,42,.75);
  }
  .badgeMini{
    padding:6px 10px;
    border-radius:999px;
    background: rgba(2,6,23,.04);
    border: 1px solid rgba(2,6,23,.06);
  }

  /* åˆ†æ•°ï¼šç”¨æ‰‹æªå›¾ç¤º */
  .gunScore{
    display:flex;
    align-items:center;
    gap:6px;
    flex-wrap:wrap;
    line-height:1;
    font-size:18px;
  }
  .gun{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    width:22px;
    height:22px;
  }
  .emptyHint{
    color: rgba(15,23,42,.45);
    font-weight:700;
    font-size:12px;
  }

  canvas#confetti{
    position:fixed; inset:0; pointer-events:none; z-index:999;
  }

  .tiny{
    margin-top:10px;
    font-size:12px;
    color: rgba(15,23,42,.70);
    line-height:1.45;
  }

  .rowBtns{
    display:flex; gap:10px; flex-wrap:wrap;
    margin-top:10px;
  }
  .btnPrimary{
    border: 1px solid rgba(255,255,255,.18);
    background: rgba(0,0,0,.25);
  }
</style>
</head>

<body>
<canvas id="confetti"></canvas>

<header>
  <div class="wrap top">
    <div class="title">
      <h1>å›¾ç‰‡è¯†å­—ï¼šæªçš„ä¸­æ–‡ï¼ˆä¸¤äººå¯¹æˆ˜ï¼‰</h1>
      <div class="sub">æ— æç¤ºï½œä¸æ˜¾ç¤ºç­”æ¡ˆï½œå›åˆæ‰‹åŠ¨æŒ‰</div>
    </div>

    <div class="controls">
      <label class="chip"><input id="ttsOn" type="checkbox" checked /> ä¸­æ–‡æœ—è¯»</label>
      <label class="chip">è¯­éŸ³ï¼š
        <select id="voiceSel" title="é€‰æ‹©ä¸­æ–‡å£°éŸ³"></select>
      </label>
      <label class="chip">è¯­é€Ÿï¼š
        <select id="rateSel" title="è¯­é€Ÿ">
          <option value="0.78">æ›´æ…¢</option>
          <option value="0.85" selected>æ…¢</option>
          <option value="0.92">æ­£å¸¸</option>
        </select>
      </label>

      <button id="resetBtn" class="btn" title="é‡ç½®æ¯”åˆ†ä¸ç­‰çº§">é‡ç½®æ¯”èµ›</button>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <section class="card">
      <div class="media" id="media"></div>
      <div class="tiny">è¯´æ˜ï¼šæœ¬æ¨¡å¼æ— æç¤ºï¼Œä¸”ä¸ä¼šæ˜¾ç¤ºç­”æ¡ˆå­—ã€‚è¯·å…ˆæŒ‰â€œè€å¸ˆå›åˆâ€æˆ–â€œå­¦ç”Ÿå›åˆâ€å‡ºé¢˜ã€‚å¯æŒ‰é”®ç›˜ 1â€“5 ä½œç­”ã€‚</div>
    </section>

    <section class="card" id="panel">
      <div class="turn">
        <div class="tag p1" id="tagP1"><span class="dot"></span>è€å¸ˆ å›åˆ</div>
        <div class="tag p2" id="tagP2"><span class="dot"></span>å­¦ç”Ÿ å›åˆ</div>
        <div class="pill">é¢˜æ•°ï¼š<strong id="count">0</strong></div>
        <div class="pill">ç­‰çº§ï¼š<strong id="level">1</strong></div>
      </div>

      <div class="barWrap" aria-label="å‡çº§è¿›åº¦">
        <div class="bar" id="bar"></div>
      </div>

      <div class="promptRow">
        <div class="neutral">è¯·çœ‹å›¾ç‰‡ï¼Œé€‰æ‹©æ­£ç¡®çš„ä¸­æ–‡è¯ã€‚</div>
        <button class="iconBtn" id="speakBtn" title="é‡æ’­æœ—è¯»ï¼ˆä¸æ˜¾ç¤ºæ–‡å­—ï¼‰">ğŸ”Š é‡æ’­</button>
      </div>

      <div class="rowBtns">
        <!-- ä¿®æ”¹ç‚¹ 1ï¼šåˆ é™¤ï¼ˆå‡ºé¢˜ï¼‰ -->
        <button id="p1Btn" class="btn btnPrimary">è€å¸ˆå›åˆ</button>
        <button id="p2Btn" class="btn btnPrimary">å­¦ç”Ÿå›åˆ</button>
        <button id="clearBtn" class="btn" title="æ¸…ç©ºå½“å‰é¢˜">æ¸…ç©ºå½“å‰é¢˜</button>
      </div>

      <div class="choices" id="choices"></div>

      <div class="msg" id="msg">å…ˆæŒ‰â€œè€å¸ˆå›åˆâ€æˆ–â€œå­¦ç”Ÿå›åˆâ€ã€‚</div>

      <div class="scoreBoard">
        <div class="sb">
          <div class="name">
            <span>è€å¸ˆ</span>
            <span style="color:var(--p1);font-weight:900;">P1</span>
          </div>
          <div class="meta">
            <!-- ä¿®æ”¹ç‚¹ 2ï¼šåˆ†æ•°ç”¨æ‰‹æªå›¾ç¤º -->
            <span class="badgeMini">
              åˆ†æ•°ï¼š
              <span class="gunScore" id="p1ScoreGuns" title="0">
                <span class="emptyHint">ï¼ˆæš‚æ— ï¼‰</span>
              </span>
            </span>
            <span class="badgeMini">è¿å¯¹ï¼š<strong id="p1Streak">0</strong></span>
          </div>
        </div>

        <div class="sb">
          <div class="name">
            <span>å­¦ç”Ÿ</span>
            <span style="color:var(--p2);font-weight:900;">P2</span>
          </div>
          <div class="meta">
            <span class="badgeMini">
              åˆ†æ•°ï¼š
              <span class="gunScore" id="p2ScoreGuns" title="0">
                <span class="emptyHint">ï¼ˆæš‚æ— ï¼‰</span>
              </span>
            </span>
            <span class="badgeMini">è¿å¯¹ï¼š<strong id="p2Streak">0</strong></span>
          </div>
        </div>
      </div>

      <div class="tiny">è§„åˆ™ï¼šæ— æç¤ºã€æ— é¢˜é¢æ–‡å­—æ˜¾ç¤ºã€‚æ¯æ¬¡ç”±ä½ é€‰æ‹©â€œè€å¸ˆå›åˆ/å­¦ç”Ÿå›åˆâ€å‡ºæ–°é¢˜ï¼›ç­”å¯¹åŠ åˆ†å¹¶å‡çº§ï¼ˆç­‰çº§è¶Šé«˜é€‰é¡¹è¶Šå¤šï¼‰ã€‚</div>
    </section>
  </div>
</main>

<script>
/* ====== å›¾ç‰‡æ¥æºï¼šGitHub raw ====== */
const RAW_BASE = "https://raw.githubusercontent.com/AISAGA21005GAOSHUNU/gun/main/assets/";

/* ====== é¢˜åº“ï¼šå…­ç§ ====== */
const bank = [
  { zh:"æ‰‹æª",  file:"shouqiang.png" },
  { zh:"æ­¥æª",  file:"buqiang.png" },
  { zh:"éœ°å¼¹æª",file:"xiandanqiang.png" },
  { zh:"å†²é”‹æª",file:"chongfengqiang.png" },
  { zh:"ç‹™å‡»æª",file:"jujiqiang.png" },
  { zh:"æœºæª",  file:"jiqiang.png" },
].map(x => ({...x, img: RAW_BASE + x.file}));

/* ====== ç©å®¶ ====== */
const P = [
  { name:"è€å¸ˆ", score:0, streak:0 },
  { name:"å­¦ç”Ÿ", score:0, streak:0 },
];

/* ====== çŠ¶æ€ ====== */
let count = 0;
let level = 1;
let xp = 0;

let current = null;
let currentTurn = null;  // 0/1ï¼›null è¡¨ç¤ºè¿˜æœªé€‰å›åˆ
let optionIndexToText = [];
let answered = false;

/* ====== DOM ====== */
const media = document.getElementById("media");
const choicesBox = document.getElementById("choices");
const msg = document.getElementById("msg");
const countEl = document.getElementById("count");
const levelEl = document.getElementById("level");
const bar = document.getElementById("bar");

const tagP1 = document.getElementById("tagP1");
const tagP2 = document.getElementById("tagP2");

const p1ScoreGuns = document.getElementById("p1ScoreGuns");
const p2ScoreGuns = document.getElementById("p2ScoreGuns");
const p1StreakEl = document.getElementById("p1Streak");
const p2StreakEl = document.getElementById("p2Streak");

document.getElementById("p1Btn").addEventListener("click", () => startTurn(0));
document.getElementById("p2Btn").addEventListener("click", () => startTurn(1));
document.getElementById("clearBtn").addEventListener("click", clearCurrent);
document.getElementById("resetBtn").addEventListener("click", resetGame);
document.getElementById("speakBtn").addEventListener("click", () => speak(current?.zh || ""));

/* ====== é”®ç›˜ 1-5 ä½œç­” ====== */
document.addEventListener("keydown", (e) => {
  if(!current || answered) return;
  const k = e.key;
  if(k >= "1" && k <= "5"){
    const idx = Number(k) - 1;
    if(idx >= 0 && idx < optionIndexToText.length){
      const text = optionIndexToText[idx];
      const btn = document.querySelector(`[data-idx="${idx}"]`);
      if(btn) choose(text, btn);
    }
  }
});

/* ====== TTS ====== */
const ttsOn = document.getElementById("ttsOn");
const voiceSel = document.getElementById("voiceSel");
const rateSel = document.getElementById("rateSel");

function loadVoices(){
  const all = speechSynthesis.getVoices();
  const zh = all.filter(v => /zh|cmn/i.test(v.lang) || /Chinese/i.test(v.name));
  const list = zh.length ? zh : all;
  voiceSel.innerHTML = "";
  list.forEach((v, idx) => {
    const opt = document.createElement("option");
    opt.value = String(idx);
    opt.textContent = `${v.name} (${v.lang})`;
    voiceSel.appendChild(opt);
  });
  if(zh.length){
    const defaultIndex = list.indexOf(zh[0]);
    voiceSel.value = String(defaultIndex);
  }else{
    voiceSel.value = "0";
  }
}
if("speechSynthesis" in window){
  loadVoices();
  speechSynthesis.onvoiceschanged = loadVoices;
}
function speak(text){
  if(!ttsOn.checked) return;
  if(!("speechSynthesis" in window)) return;
  if(!text) return;

  const all = speechSynthesis.getVoices();
  const idx = Number(voiceSel.value || 0);
  const v = all[idx] || all.find(x => /zh|cmn/i.test(x.lang)) || null;

  const u = new SpeechSynthesisUtterance(text);
  u.lang = "zh-CN";
  if(v) u.voice = v;
  u.rate = Number(rateSel.value || 0.85);
  u.pitch = 1.0;
  u.volume = 1.0;

  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ====== è½»éŸ³æ•ˆ ====== */
let audioCtx = null;
function beep(freq, dur=0.08){
  try{
    audioCtx = audioCtx || new (window.AudioContext || window.webkitAudioContext)();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = "sine";
    o.frequency.value = freq;
    g.gain.value = 0.06;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    setTimeout(()=>{ o.stop(); }, dur*1000);
  }catch(e){}
}

/* ====== å½©å¸¦ ====== */
const cvs = document.getElementById("confetti");
const ctx = cvs.getContext("2d");
let conf = [];
function resize(){ cvs.width = innerWidth; cvs.height = innerHeight; }
addEventListener("resize", resize); resize();

function shootConfetti(){
  const n = 80;
  for(let i=0;i<n;i++){
    conf.push({
      x: innerWidth*0.62 + (Math.random()-0.5)*160,
      y: innerHeight*0.22,
      vx: (Math.random()-0.5)*10,
      vy: Math.random()*-9 - 6,
      g: 0.22 + Math.random()*0.08,
      r: 3 + Math.random()*4,
      a: 1
    });
  }
}
function tick(){
  ctx.clearRect(0,0,cvs.width,cvs.height);
  conf = conf.filter(p => p.a > 0);
  for(const p of conf){
    p.vy += p.g;
    p.x += p.vx;
    p.y += p.vy;
    p.a -= 0.012;
    ctx.globalAlpha = Math.max(p.a,0);
    ctx.beginPath();
    ctx.arc(p.x, p.y, p.r, 0, Math.PI*2);
    ctx.fillStyle = "rgba(255,255,255,1)";
    ctx.fill();
  }
  ctx.globalAlpha = 1;
  requestAnimationFrame(tick);
}
tick();

/* ====== éš¾åº¦ï¼ˆæ— æç¤ºç‰ˆï¼šåªå¢é€‰é¡¹æ•°ï¼‰ ====== */
function choiceCount(){
  if(level <= 1) return 3;
  if(level === 2) return 4;
  return 5;
}
function setProgress(){
  const need = 5;
  const pct = Math.min(100, (xp / need) * 100);
  bar.style.width = pct + "%";
}
function levelUpIfNeeded(){
  const need = 5;
  if(xp >= need){
    xp = 0;
    level += 1;
    levelEl.textContent = String(level);
    msg.textContent = `å‡çº§ï¼ç­‰çº§ ${level}ï¼šé€‰é¡¹æ›´å¤šï¼Œæ›´æœ‰æŒ‘æˆ˜ã€‚`;
    msg.className = "msg ok";
    shootConfetti();
    beep(880, 0.10); beep(990, 0.10);
  }
  setProgress();
}

function shuffle(arr){
  const a = arr.slice();
  for(let i=a.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [a[i],a[j]] = [a[j],a[i]];
  }
  return a;
}

function refreshTurnUI(){
  tagP1.classList.toggle("active", currentTurn === 0);
  tagP2.classList.toggle("active", currentTurn === 1);
}

/* åˆ†æ•°æ¸²æŸ“ä¸ºæ‰‹æªå›¾ç¤º */
function renderGunScore(el, score){
  el.innerHTML = "";
  el.title = String(score); // è€å¸ˆè‡ªå·±ç”¨é¼ æ ‡æ‚¬åœå¯çœ‹åˆ°æ•°å­—ï¼ˆä¸æ˜¾çœ¼ï¼‰
  if(score <= 0){
    const hint = document.createElement("span");
    hint.className = "emptyHint";
    hint.textContent = "ï¼ˆæš‚æ— ï¼‰";
    el.appendChild(hint);
    return;
  }
  // é™åˆ¶å±•ç¤ºé•¿åº¦ï¼Œé¿å…åˆ†æ•°å¤ªå¤§æŠŠç‰ˆé¢æŒ¤çˆ†ï¼šè¶…è¿‡ 20 ç”¨ â€œÃ—Nâ€
  const MAX = 20;
  const show = Math.min(score, MAX);
  for(let i=0;i<show;i++){
    const s = document.createElement("span");
    s.className = "gun";
    s.textContent = "ğŸ”«";
    el.appendChild(s);
  }
  if(score > MAX){
    const more = document.createElement("span");
    more.className = "emptyHint";
    more.textContent = `Ã—${score}`;
    el.appendChild(more);
  }
}

function refreshScoreUI(){
  renderGunScore(p1ScoreGuns, P[0].score);
  renderGunScore(p2ScoreGuns, P[1].score);
  p1StreakEl.textContent = String(P[0].streak);
  p2StreakEl.textContent = String(P[1].streak);
}

/* ====== æ¸²æŸ“å›¾ç‰‡ ====== */
function renderMedia(item){
  media.innerHTML = "";
  const img = new Image();
  img.alt = "è¯†å­—å›¾ç‰‡";
  img.src = item.img;
  img.onload = () => media.appendChild(img);
  img.onerror = () => { media.textContent = "å›¾ç‰‡åŠ è½½å¤±è´¥ï¼ˆè¯·æ£€æŸ¥æ–‡ä»¶å/ç½‘ç»œï¼‰"; };
}

/* ====== æ‰‹åŠ¨å›åˆï¼šæŒ‰æŒ‰é’®æ‰å‡ºé¢˜ ====== */
function startTurn(turn){
  currentTurn = turn;
  refreshTurnUI();
  newQuestion(true);
}

function newQuestion(autoSpeak=false){
  current = bank[Math.floor(Math.random()*bank.length)];
  answered = false;

  count += 1;
  countEl.textContent = String(count);

  renderMedia(current);

  const k = choiceCount();
  const others = shuffle(bank.filter(x => x.zh !== current.zh)).slice(0, Math.max(0, k-1)).map(x => x.zh);
  const opts = shuffle([current.zh, ...others]);

  optionIndexToText = opts.slice();

  choicesBox.innerHTML = "";
  opts.forEach((opt, idx) => {
    const b = document.createElement("button");
    b.className = "choice";
    b.dataset.idx = String(idx);

    const num = document.createElement("span");
    num.className = "num";
    num.textContent = String(idx + 1);

    const txt = document.createElement("span");
    txt.className = "txt";
    txt.textContent = opt;

    b.appendChild(num);
    b.appendChild(txt);

    b.addEventListener("click", () => choose(opt, b));
    choicesBox.appendChild(b);
  });

  msg.textContent = `è½®åˆ° ${P[currentTurn].name}ï¼šè¯·é€‰æ‹©æ­£ç¡®çš„ä¸­æ–‡è¯ã€‚ï¼ˆæŒ‰ 1-${opts.length}ï¼‰`;
  msg.className = "msg";

  if(autoSpeak) speak(current.zh);
}

/* ====== ä½œç­”ï¼šç­”å¯¹åä¸è‡ªåŠ¨å‡ºæ–°é¢˜ ====== */
function choose(opt, btn){
  if(!current || answered) return;

  if(opt === current.zh){
    answered = true;

    P[currentTurn].score += 1;
    P[currentTurn].streak += 1;
    P[1-currentTurn].streak = 0;

    xp += 1;

    msg.textContent = `ç­”å¯¹äº†ï¼è¦å‡ºæ–°é¢˜è¯·æŒ‰â€œè€å¸ˆå›åˆâ€æˆ–â€œå­¦ç”Ÿå›åˆâ€ã€‚`;
    msg.className = "msg ok";

    beep(660, 0.08);
    if(P[currentTurn].streak >= 2) shootConfetti();
    speak("ç­”å¯¹äº†");

    levelUpIfNeeded();
    refreshScoreUI();
  }else{
    P[currentTurn].streak = 0;
    refreshScoreUI();
    btn.classList.add("wrong");
    msg.textContent = `ä¸å¯¹ã€‚å†è¯•ä¸€æ¬¡ã€‚ï¼ˆæ— æç¤ºï¼‰`;
    msg.className = "msg bad";
    beep(220, 0.10);
    speak("å†è¯•ä¸€æ¬¡");
    setTimeout(()=>btn.classList.remove("wrong"), 520);
  }
}

function clearCurrent(){
  current = null;
  answered = false;
  optionIndexToText = [];
  choicesBox.innerHTML = "";
  media.innerHTML = "";
  msg.textContent = "å·²æ¸…ç©ºã€‚è¯·æŒ‰â€œè€å¸ˆå›åˆâ€æˆ–â€œå­¦ç”Ÿå›åˆâ€ã€‚";
  msg.className = "msg";
}

function resetGame(){
  count = 0; level = 1; xp = 0;
  current = null; currentTurn = null; answered = false;
  optionIndexToText = [];
  P[0].score = 0; P[0].streak = 0;
  P[1].score = 0; P[1].streak = 0;

  countEl.textContent = "0";
  levelEl.textContent = "1";
  choicesBox.innerHTML = "";
  media.innerHTML = "";
  msg.textContent = "é‡ç½®å®Œæˆã€‚è¯·æŒ‰â€œè€å¸ˆå›åˆâ€æˆ–â€œå­¦ç”Ÿå›åˆâ€ã€‚";
  msg.className = "msg";

  setProgress();
  refreshScoreUI();
  refreshTurnUI();
}

/* init */
levelEl.textContent = String(level);
setProgress();
refreshScoreUI();
clearCurrent();
</script>

</body>
</html>
